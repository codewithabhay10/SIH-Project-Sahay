<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM-AJAY Sahayak</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* SCREENS & MODALS */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(44, 62, 80, 0.98); z-index: 2000; }
        .box { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* LANGUAGES */
        .lang-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .lang-btn { padding: 15px; border: 2px solid #eee; border-radius: 10px; background: white; cursor: pointer; transition: 0.2s; font-size: 1.1rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .lang-btn:active { transform: scale(0.95); background: #e3f2fd; border-color: var(--accent); }
        .lang-btn span { font-size: 2rem; }
        
        .btn-main { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1rem; margin-top: 15px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }

        /* APP LAYOUT */
        #app-container { display: none; height: 100vh; flex-direction: column; }
        header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .header-title { font-size: 1.2rem; font-weight: bold; }
        
        .main-content { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* OFFICIAL SIDEBAR */
        .sidebar { width: 280px; background: white; border-right: 1px solid #ddd; display: none; flex-direction: column; padding: 20px; overflow-y: auto; flex-shrink: 0; }
        .sidebar.active { display: flex; } 
        
        .tool-btn { text-align: left; padding: 12px; margin-bottom: 10px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .tool-btn:hover { background: #e3f2fd; border-color: var(--accent); }
        .tool-icon { font-size: 1.2rem; }

        /* CHAT SECTION */
        .chat-section { flex: 1; display: flex; flex-direction: column; background: #efe7dd; position: relative; min-width: 0; }
        .chat-history { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .message { max-width: 80%; padding: 15px; border-radius: 15px; font-size: 1rem; line-height: 1.5; }
        .bot { align-self: flex-start; background: white; border-top-left-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .user { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* INPUT AREA */
        .input-area { padding: 15px; background: #f0f0f0; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ccc; z-index: 5; }
        .input-area input { flex: 1; border-radius: 30px; border: none; padding: 15px 20px; font-size: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .btn-mic { width: 50px; height: 50px; border-radius: 50%; border: none; background: white; cursor: pointer; font-size: 1.5rem; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #555; transition: 0.2s; }
        .btn-mic.listening { background: #e74c3c; color: white; animation: pulse 1.5s infinite; }
        .btn-send { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--accent); color: white; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen">
        <div class="box">
            <h2>ğŸ” Login / à¤ªà¥à¤°à¤µà¥‡à¤¶</h2>
            <div class="lang-grid" style="display:flex; justify-content: center;">
                <div class="lang-btn" style="width:120px;" onclick="selectRole('beneficiary')"><span>ğŸ‘¤</span>Beneficiary<br><small>à¤²à¤¾à¤­à¤¾à¤°à¥à¤¥à¥€</small></div>
                <div class="lang-btn" style="width:120px;" onclick="selectRole('official')"><span>ğŸ‘®</span>Official<br><small>à¤…à¤§à¤¿à¤•à¤¾à¤°à¥€</small></div>
            </div>
            
            <div id="official-auth" style="display:none; margin-top:20px;">
                <input type="password" id="admin-key" placeholder="Enter Key (hackathon123)">
                <button class="btn-main" onclick="officialLogin()">Access Dashboard</button>
            </div>
        </div>
    </div>

    <div id="screen-lang" class="screen" style="display: none;">
        <div class="box">
            <h2>ğŸ—£ï¸ Select Language</h2>
            <div class="lang-grid" style="grid-template-columns: 1fr 1fr; max-height: 400px; overflow-y: auto;">
                <button class="lang-btn" onclick="setLang('English', 'en-US', 'Hello! Tap the mic to speak.')">
                    <span>ğŸ‡¬ğŸ‡§</span>English
                </button>
                <button class="lang-btn" onclick="setLang('Hindi', 'hi-IN', 'à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤¬à¤¾à¤¤ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤®à¤¾à¤‡à¤• à¤¦à¤¬à¤¾à¤à¤‚à¥¤')">
                    <span>ğŸ‡®ğŸ‡³</span>Hindi (à¤¹à¤¿à¤‚à¤¦à¥€)
                </button>
                <button class="lang-btn" onclick="setLang('Punjabi', 'pa-IN', 'à¨¸à¨¤ à¨¸à©à¨°à©€ à¨…à¨•à¨¾à¨²! à¨®à¨¾à¨ˆà¨• à¨¦à¨¬à¨¾ à¨•à©‡ à¨¬à©‹à¨²à©‹à¥¤')">
                    <span>ğŸ‡®ğŸ‡³</span>Punjabi (à¨ªà©°à¨œà¨¾à¨¬à©€)
                </button>
                <button class="lang-btn" onclick="setLang('Marathi', 'mr-IN', 'à¤¨à¤®à¤¸à¥à¤•à¤¾à¤°! à¤¬à¥‹à¤²à¤£à¥à¤¯à¤¾à¤¸à¤¾à¤ à¥€ à¤®à¤¾à¤ˆà¤• à¤¦à¤¾à¤¬à¤¾.')">
                    <span>ğŸ‡®ğŸ‡³</span>Marathi (à¤®à¤°à¤¾à¤ à¥€)
                </button>
                <button class="lang-btn" onclick="setLang('Gujarati', 'gu-IN', 'àª¨àª®àª¸à«àª¤à«‡! àª¬à«‹àª²àªµàª¾ àª®àª¾àªŸà«‡ àª®àª¾àª‡àª• àª¦àª¬àª¾àªµà«‹.')">
                    <span>ğŸ‡®ğŸ‡³</span>Gujarati (àª—à«àªœàª°àª¾àª¤à«€)
                </button>
                <button class="lang-btn" onclick="setLang('Tamil', 'ta-IN', 'à®µà®£à®•à¯à®•à®®à¯! à®ªà¯‡à®š à®®à¯ˆà®•à¯à®•à¯ˆ à®¤à®Ÿà¯à®Ÿà®µà¯à®®à¯.')">
                    <span>ğŸ‡®ğŸ‡³</span>Tamil (à®¤à®®à®¿à®´à¯)
                </button>
                <button class="lang-btn" onclick="setLang('Telugu', 'te-IN', 'à°¨à°®à°¸à±à°•à°¾à°°à°‚! à°®à°¾à°Ÿà±à°²à°¾à°¡à°Ÿà°¾à°¨à°¿à°•à°¿ à°®à±ˆà°•à± à°¨à±Šà°•à±à°•à°‚à°¡à°¿.')">
                    <span>ğŸ‡®ğŸ‡³</span>Telugu (à°¤à±†à°²à±à°—à±)
                </button>
                <button class="lang-btn" onclick="setLang('Kannada', 'kn-IN', 'à²¨à²®à²¸à³à²•à²¾à²°! à²®à²¾à²¤à²¨à²¾à²¡à²²à³ à²®à³ˆà²•à³ à²’à²¤à³à²¤à²¿à²°à²¿.')">
                    <span>ğŸ‡®ğŸ‡³</span>Kannada (à²•à²¨à³à²¨à²¡)
                </button>
                <button class="lang-btn" onclick="setLang('Bengali', 'bn-IN', 'à¦¨à¦®à¦¸à§à¦•à¦¾à¦°! à¦•à¦¥à¦¾ à¦¬à¦²à¦¤à§‡ à¦®à¦¾à¦‡à¦• à¦Ÿà¦¿à¦ªà§à¦¨à¥¤')">
                    <span>ğŸ‡®ğŸ‡³</span>Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)
                </button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="header-title">ğŸ¤– Sahayak <span id="mode-badge" style="font-size:0.8rem; opacity:0.8;"></span></div>
            <div>
                <button onclick="toggleAudio()" id="audio-btn" style="background:none; border:none; color:white; font-size:1.8rem; margin-right:15px; cursor:pointer;" title="Pause/Play">ğŸ”Š</button>
                
                <button onclick="location.reload()" style="background:#c0392b; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Exit</button>
            </div>
        </header>

        <div class="main-content">
            <div id="official-sidebar" class="sidebar">
                <h3 style="color: var(--primary); margin-bottom: 20px;">ğŸ› ï¸ Admin Toolkit</h3>
                <button class="tool-btn" onclick="autoAsk('What is the maximum subsidy for E-Rickshaws?')">
                    <span class="tool-icon">ğŸ’°</span> Check Subsidy Rules
                </button>
                <button class="tool-btn" onclick="autoAsk('Draft a formal rejection letter for an applicant with income > 2.5L')">
                    <span class="tool-icon">ğŸ“</span> Draft Rejection
                </button>
                <button class="tool-btn" onclick="autoAsk('What documents are required for a new applicant?')">
                    <span class="tool-icon">ğŸ“„</span> Verify Docs
                </button>
                <button class="tool-btn" onclick="autoAsk('Summarize the Grievance Redressal process')">
                    <span class="tool-icon">âš–ï¸</span> Compliance Rules
                </button>
                <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                <button class="tool-btn" onclick="fetchAuditLogs()" style="background-color: #34495e; color: white;">
                    <span class="tool-icon">ğŸ“œ</span> View Transparency Logs
                </button>
            </div>

            <div class="chat-section">
                <div id="chat-history" class="chat-history"></div>
                <div class="input-area">
                    <button id="mic-btn" class="btn-mic" onclick="toggleListening()">ğŸ™ï¸</button>
                    <input type="text" id="user-msg" placeholder="Type or Speak..." onkeypress="if(event.key==='Enter') send()">
                    <button class="btn-send" onclick="send()">â¤</button>
                </div>
            </div>
        </div>
    </div>

    <div id="audit-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:10px; box-shadow:0 0 50px rgba(0,0,0,0.5); z-index:3000; width:300px; max-height:400px; overflow-y:auto;">
        <h3>Transparency Logs</h3>
        <div id="audit-list" style="font-size:0.85rem; background:#f9f9f9; padding:10px; margin-bottom:10px;">Loading...</div>
        <button class="btn-main" onclick="document.getElementById('audit-modal').style.display='none'">Close</button>
    </div>

    <script>
        let ROLE='beneficiary', ADMIN_KEY=null, SELECTED_LANG='English', LANG_CODE='en-US';
        let GLOBAL_MUTE = false;
        const API = "http://127.0.0.1:8000";

        // --- NAVIGATION ---
        function selectRole(r) { ROLE=r; r==='official' ? document.getElementById('official-auth').style.display='block' : goToLangScreen(); }
        function goToLangScreen() { document.getElementById('screen-login').style.display='none'; document.getElementById('screen-lang').style.display='flex'; }
        
        function officialLogin() {
            if(document.getElementById('admin-key').value!=='hackathon123') return alert("Wrong Key");
            ADMIN_KEY = document.getElementById('admin-key').value;
            document.getElementById('screen-login').style.display='none';
            document.getElementById('app-container').style.display='flex';
            document.getElementById('official-sidebar').classList.add('active');
            document.getElementById('mode-badge').innerText="(Official Mode)";
            addMsg('bot', "Welcome, Officer. Ready to assist.");
        }

        function setLang(n, c, g) {
            SELECTED_LANG = n;
            LANG_CODE = c;
            document.getElementById('screen-lang').style.display='none';
            document.getElementById('app-container').style.display='flex';
            document.getElementById('mode-badge').innerText=`(${n})`;
            addMsg('bot', g);
            speak(g);
        }

        // --- MIC LOGIC (REAL-TIME TRANSCRIPTION) ---
        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new Recognition();
        
        // CRITICAL FIX: Set to TRUE to see words while speaking
        recognition.interimResults = true; 
        recognition.continuous = false;

        function toggleListening() {
            try { recognition.abort(); } catch(e) {}
            recognition.lang = LANG_CODE; 
            document.getElementById('mic-btn').classList.add('listening');
            document.getElementById('user-msg').placeholder = "Listening...";
            document.getElementById('user-msg').value = ""; // Clear box
            
            setTimeout(() => { try { recognition.start(); } catch(e) {} }, 100);
        }

        recognition.onend = () => { 
            document.getElementById('mic-btn').classList.remove('listening'); 
            document.getElementById('user-msg').placeholder = "Type or Speak...";
        };

        recognition.onresult = (event) => {
            let transcript = '';
            // Loop through results to build the sentence
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                transcript += event.results[i][0].transcript;
            }
            // Put it in the box LIVE
            const inputBox = document.getElementById('user-msg');
            inputBox.value = transcript; 
            inputBox.focus(); 
        };

        recognition.onerror = (e) => {
            console.error(e.error);
            document.getElementById('mic-btn').classList.remove('listening');
            if(e.error === 'not-allowed') alert("Allow Microphone Permission!");
        };

        // --- SMART AUDIO CONTROLLER (PAUSE/RESUME) ---
        function toggleAudio() {
            const btn = document.getElementById('audio-btn');
            
            if (window.speechSynthesis.speaking) {
                if (window.speechSynthesis.paused) {
                    window.speechSynthesis.resume();
                    btn.innerText = "â¸ï¸"; // Show Pause icon
                } else {
                    window.speechSynthesis.pause();
                    btn.innerText = "â–¶ï¸"; // Show Resume icon
                }
            } else {
                // Toggle global mute state
                GLOBAL_MUTE = !GLOBAL_MUTE;
                btn.innerText = GLOBAL_MUTE ? "ğŸ”‡" : "ğŸ”Š";
                if(GLOBAL_MUTE) window.speechSynthesis.cancel();
            }
        }

        function speak(text) {
            if(GLOBAL_MUTE) return;
            window.speechSynthesis.cancel();
            
            // Clean Text for better audio
            const cleanText = text.replace(/[*#_`]/g, '')
                                .replace(/https?:\/\/\S+/g, 'the website')
                                .replace(/[:|]/g, ' ')
                                .replace(/\n/g, '. ');

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = LANG_CODE;
            
            // Smart Voice Picker
            const voices = window.speechSynthesis.getVoices();
            let bestVoice = voices.find(v => v.lang === LANG_CODE && (v.name.includes('Google') || v.name.includes('Neural')));
            if (!bestVoice) bestVoice = voices.find(v => v.lang === LANG_CODE);
            if (bestVoice) utterance.voice = bestVoice;

            utterance.rate = (LANG_CODE === 'en-US') ? 1.0 : 0.9; 
            
            // Updates Icon while speaking
            utterance.onstart = () => { document.getElementById('audio-btn').innerText = "â¸ï¸"; };
            utterance.onend = () => { document.getElementById('audio-btn').innerText = GLOBAL_MUTE ? "ğŸ”‡" : "ğŸ”Š"; };

            window.speechSynthesis.speak(utterance);
        }
        window.speechSynthesis.getVoices();

        // --- CHAT LOGIC ---
        async function send() {
            const input = document.getElementById('user-msg');
            const msg = input.value.trim(); if(!msg) return;
            addMsg('user', msg); input.value = '';
            
            try {
                const res = await fetch(API+'/chat', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ role: ROLE, user_id: ROLE==='beneficiary'?"Guest":null, message: `[Spoken in ${SELECTED_LANG}] ${msg}` })
                });
                const data = await res.json();
                addMsg('bot', data.answer);
                speak(data.answer);
            } catch(e) { addMsg('bot', "Server Error"); }
        }

        // --- OFFICIAL UTILS ---
        function autoAsk(q) { document.getElementById('user-msg').value=q; send(); }
        
        async function fetchAuditLogs() {
            document.getElementById('audit-modal').style.display='block';
            const list = document.getElementById('audit-list'); list.innerHTML="Loading...";
            try {
                const res = await fetch(`${API}/audit/logs?admin_key=${ADMIN_KEY}`);
                const logs = await res.json();
                list.innerHTML = logs.length ? logs.map(l => `<div><b>${l.action_type}</b>: ${l.details}</div>`).join('<hr>') : "No logs.";
            } catch(e) { list.innerHTML="Error"; }
        }

        function addMsg(sender, text) {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            document.getElementById('chat-history').appendChild(div);
            document.getElementById('chat-history').scrollTop = 9999;
        }
    </script>
</body>
</html>